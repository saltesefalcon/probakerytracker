<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro-Bakery — Catalog Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b0e; --panel:#121218; --ink:#f6f6f6; --muted:#a6a6b0;
      --gold:#d4af37; --gold-2:#b99416; --red:#ef4444; --line:#23232b; --card:#171720;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:1.7rem}
    h1 .brand{color:var(--gold)}
    .sub{color:var(--muted);font-size:.95rem}
    .status{color:var(--muted);font-size:.92rem}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 20px rgba(0,0,0,.25);padding:14px;overflow:visible}
    label{font-weight:600;font-size:.95rem;color:var(--muted)}
    input,select,button{padding:10px 12px;box-sizing:border-box;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink);font-size:1rem}
    input,select{width:100%} button{width:auto;display:inline-block;cursor:pointer}
    .btn{border:1px solid var(--gold);background:transparent;color:var(--gold);transition:.2s}
    .btn:hover{background:var(--gold);color:var(--bg)}
    .btn.primary{background:var(--gold);color:var(--bg);border:1px solid var(--gold)}
    .btn.primary:hover{background:var(--gold-2);border-color:var(--gold-2)}
    .btn.danger{border-color:var(--red);color:var(--red)}
    .btn.danger:hover{background:var(--red);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .muted{color:var(--muted);font-size:.9rem}
    .spacer{height:12px}
    .tr{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 120px;gap:8px;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .th{font-weight:700;color:var(--gold)}
    .small{font-size:.85rem}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .admin-only{display:none}
    body.admin .admin-only{display:block}
    .admin-btns{display:flex;gap:8px;flex-wrap:wrap}
    @media(max-width:900px){ .tr{grid-template-columns:1.6fr 1fr 1fr 1fr 1fr 110px} }
    @media(max-width:700px){ .grid-3,.grid-2{grid-template-columns:1fr} .tr{grid-template-columns:1.4fr 1fr 1fr 1fr 1fr 100px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1><span class="brand">Pro-Bakery</span> — Catalog Admin</h1>
        <div class="sub">Manage the product catalog that powers the Transfer Tracker.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="btn" href="index.html" title="Back to tracker">Back to Tracker</a>
        <span id="fb-status" class="status">Firebase: <em>checking…</em></span>
        <button id="login-btn" type="button" class="btn primary">Login</button>
      </div>
    </div>

    <div class="panel" style="margin-bottom:14px">
      <div class="row" style="gap:10px;align-items:center">
        <input id="search" placeholder="Search products…" style="flex:1" />
        <button id="clear-search" class="btn">Clear</button>

        <!-- CSV tools (admin only) -->
        <div class="admin-only admin-btns">
          <button id="csv-export" class="btn">Export CSV</button>
          <button id="csv-template" class="btn">Download Blank CSV</button>
          <button id="csv-template-print" class="btn">Print Blank Template</button>
          <input id="csv-file" type="file" accept=".csv" style="display:none">
          <button id="csv-import" class="btn primary">Import CSV</button>
        </div>
      </div>
      <div class="small muted admin-only" style="margin-top:6px">
        CSV columns: <code>id</code> (optional), <code>name</code>, <code>baseUnit</code> (each,piece,kg,g,lb,L,ml,"fl oz"),
        <code>pricePerBase</code> (number), <code>useConversions</code> (true/false), <code>active</code> (true/false).
        Existing IDs are overwritten; new rows are added.
      </div>
    </div>

    <!-- Add/Edit form -->
    <div class="panel admin-only" style="margin-bottom:14px">
      <h2 style="margin:0 0 10px;color:var(--gold)">Add / Edit Product</h2>
      <div class="grid-3">
        <label>Name <input id="cat-name" placeholder="e.g., Chocolate Cake"></label>
        <label>Base Unit
          <select id="cat-baseunit">
            <option value="each">each</option><option value="piece">piece</option>
            <option value="kg">kg</option><option value="g">g</option><option value="lb">lb</option>
            <option value="L">L</option><option value="ml">ml</option><option value="fl oz">fl oz</option>
          </select>
        </label>
        <label>Price per Base Unit <input id="cat-price" type="number" step="0.01" placeholder="e.g., 25.00"></label>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <label>Use Conversions?
          <select id="cat-useconv"><option value="false">No (base unit only)</option><option value="true">Yes (offer related units)</option></select>
        </label>
        <label>Active?
          <select id="cat-active"><option value="true">Active</option><option value="false">Inactive</option></select>
        </label>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button id="cat-save" class="btn primary" type="button">Save / Update</button>
          <button id="cat-clear" class="btn" type="button">Clear</button>
        </div>
      </div>
      <div class="small muted" id="edit-id" style="margin-top:6px;display:none"></div>
    </div>

    <!-- Catalog table -->
    <div class="panel">
      <h2 style="margin:0 0 10px;color:var(--gold)">Catalog</h2>
      <div class="tr th">
        <div>Name</div><div>Base Unit</div><div>Price/Base</div><div>Conversions</div><div>Active</div><div class="right">Actions</div>
      </div>
      <div id="rows" style="display:grid;gap:8px;margin-top:6px"></div>
      <div id="empty" class="muted" style="margin-top:10px;display:none">No products found.</div>
    </div>
  </div>

  <!-- Firebase + PapaParse -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const ADMIN_UIDS = new Set([
      "In9nS195FPamjwoTM8aHDjJRq8r2",
      "csKdZoNF3ufwPVNS1tUmeRFzCnF2"
    ]);

    /* --- Firebase init --- */
    const firebaseConfig = {
      apiKey: "AIzaSyAMnZy_gRIu43w6RyvcgRFHcV6xQjBAriM",
      authDomain: "food-tracker-fd312.firebaseapp.com",
      projectId: "food-tracker-fd312",
      storageBucket: "food-tracker-fd312.firebasestorage.app",
      messagingSenderId: "1012475913662",
      appId: "1:1012475913662:web:81837595030d4b8a8105ef"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const fs   = firebase.firestore();

    const $ = (sel)=>document.querySelector(sel);
    const rowsEl = $("#rows"), emptyEl = $("#empty");

    /* --- Auth UI --- */
    function applyAuthUI(user){
      const signedIn = !!user;
      const isAdmin  = !!user && ADMIN_UIDS.has(user.uid);
      document.body.classList.toggle("admin", isAdmin);
      $("#login-btn").textContent = signedIn ? "Logout" : "Login";
    }
    auth.onAuthStateChanged(applyAuthUI);
    $("#login-btn").addEventListener("click", async ()=>{
      const u=auth.currentUser;
      if(u){ await auth.signOut(); return; }
      const email=prompt("Admin email:"); if(!email) return;
      const pw=prompt("Password:"); if(pw==null) return;
      try{ await auth.signInWithEmailAndPassword(email.trim(), pw); }
      catch(e){ console.error(e); alert("Login failed."); }
    });

    /* --- Connection hint --- */
    (async ()=>{
      try { await fs.collection("_ping").limit(1).get();
        $("#fb-status").innerHTML = 'Firebase: <strong style="color:#22c55e">connected</strong>';
      } catch { $("#fb-status").innerHTML = 'Firebase: <strong style="color:#f87171">offline</strong>'; }
    })();

    /* --- Live catalog list --- */
    let allDocs = [];
    fs.collection("catalog").onSnapshot(snap=>{
      allDocs = []; snap.forEach(doc => allDocs.push({ id: doc.id, ...doc.data() }));
      render(allDocs);
    }, err=> console.error(err));

    const money = n => { const x=Number(n); return isFinite(x)?`$${x.toFixed(2)}`:""; };
    const yesNo = v => v ? "Yes" : "No";

    function render(list){
      const q = ($("#search").value || "").toLowerCase().trim();
      const filtered = !q ? list : list.filter(p =>
        (p.name||"").toLowerCase().includes(q) || (p.baseUnit||"").toLowerCase().includes(q)
      );

      rowsEl.innerHTML = "";
      if (!filtered.length){ emptyEl.style.display = "block"; return; }
      emptyEl.style.display = "none";

      filtered.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      filtered.forEach(p=>{
        const row = document.createElement("div"); row.className="tr";
        row.innerHTML = `
          <div><strong>${p.name||""}</strong><div class="small muted">${p.id}</div></div>
          <div>${p.baseUnit||""}</div>
          <div>${money(p.pricePerBase)}</div>
          <div>${yesNo(!!p.useConversions)}</div>
          <div>${yesNo(!!p.active)}</div>
          <div class="right admin-only">
            <button class="btn" data-edit="${p.id}" title="Edit">Edit</button>
            <button class="btn danger" data-del="${p.id}" title="Delete">🗑</button>
          </div>`;
        rowsEl.appendChild(row);
      });

      rowsEl.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-edit");
          const p=allDocs.find(x=>x.id===id); if(!p) return;
          $("#cat-name").value=p.name||"";
          $("#cat-baseunit").value=p.baseUnit||"each";
          $("#cat-price").value=p.pricePerBase??"";
          $("#cat-useconv").value=String(!!p.useConversions);
          $("#cat-active").value=String(!!p.active);
          $("#cat-save").dataset.id=id;
          const idBox=$("#edit-id"); idBox.style.display="block"; idBox.textContent="Editing ID: "+id;
          window.scrollTo({top:0,behavior:"smooth"});
        };
      });
      rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick=async ()=>{
          if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
          const id=btn.getAttribute("data-del");
          if(!confirm("Delete this product?")) return;
          try{ await fs.collection("catalog").doc(id).delete(); }
          catch(e){ console.error(e); alert("Delete failed."); }
        };
      });
    }

    $("#search").addEventListener("input", ()=> render(allDocs));
    $("#clear-search").addEventListener("click", ()=>{ $("#search").value=""; render(allDocs); });

    /* --- Save / Clear --- */
    $("#cat-clear").addEventListener("click", ()=>{
      $("#cat-name").value=""; $("#cat-baseunit").value="each"; $("#cat-price").value="";
      $("#cat-useconv").value="false"; $("#cat-active").value="true";
      delete $("#cat-save").dataset.id; const idBox=$("#edit-id"); idBox.style.display="none"; idBox.textContent="";
    });

    function slug(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,""); }
    const ALLOWED_UNITS = ["each","piece","kg","g","lb","L","ml","fl oz"];

    $("#cat-save").addEventListener("click", async ()=>{
      if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
      const name=$("#cat-name").value.trim();
      const baseUnit=$("#cat-baseunit").value;
      const pricePerBase=parseFloat($("#cat-price").value);
      const useConversions=$("#cat-useconv").value==="true";
      const active=$("#cat-active").value==="true";
      if(!name || isNaN(pricePerBase)) return alert("Please fill Name and Price.");
      if(!ALLOWED_UNITS.includes(baseUnit)) return alert("Invalid base unit.");
      const payload={name,baseUnit,pricePerBase,useConversions,active};
      const existing=$("#cat-save").dataset.id;
      try{
        if(existing){ await fs.collection("catalog").doc(existing).set(payload, {merge:false}); }
        else{ const id=slug(name)||undefined; await fs.collection("catalog").doc(id).set(payload); }
        $("#cat-clear").click();
      }catch(e){ console.error(e); alert("Save failed."); }
    });

    /* --- CSV Tools --- */
    function bool(v, def=false){
      if (typeof v === "boolean") return v;
      if (v==null || v==="") return def;
      const s=String(v).trim().toLowerCase();
      if (["true","1","yes","y"].includes(s)) return true;
      if (["false","0","no","n"].includes(s)) return false;
      return def;
    }
    function toCSV(rows){
      const headers=["id","name","baseUnit","pricePerBase","useConversions","active"];
      const out=[headers.join(",")];
      for(const r of rows){
        const vals=headers.map(h=>{
          let v=r[h]??"";
          if(typeof v==="string" && (v.includes('"')||v.includes(",")||v.includes("\n"))) v='"'+v.replace(/"/g,'""')+'"';
          return v;
        });
        out.push(vals.join(","));
      }
      return out.join("\n");
    }
    function downloadFile(name, mime, text){
      const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
    }

    $("#csv-export").addEventListener("click", ()=>{
      const rows=(allDocs||[]).map(p=>({id:p.id,name:p.name||"",baseUnit:p.baseUnit||"",pricePerBase:Number(p.pricePerBase)||0,useConversions:!!p.useConversions,active:!!p.active}));
      downloadFile("catalog_export.csv","text/csv;charset=utf-8",toCSV(rows));
    });
    $("#csv-template").addEventListener("click", ()=>{
      const rows=[{id:"",name:"",baseUnit:"each",pricePerBase:"",useConversions:"false",active:"true"}];
      downloadFile("catalog_template.csv","text/csv;charset=utf-8",toCSV(rows));
    });
    $("#csv-template-print").addEventListener("click", ()=>{
      const w=window.open("","_blank");
      w.document.write(
        '<html><head><title>Catalog Template</title>'+
        '<style>body{font-family:Arial;padding:16px} table{border-collapse:collapse} th,td{border:1px solid #444;padding:6px 10px}</style>'+
        '</head><body>'+
        '<h3>Catalog CSV Template</h3>'+
        '<p>Columns: <b>id</b> (optional), <b>name</b>, <b>baseUnit</b> (each,piece,kg,g,lb,L,ml,"fl oz"), <b>pricePerBase</b> (number), <b>useConversions</b> (true/false), <b>active</b> (true/false)</p>'+
        '<table><thead><tr><th>id</th><th>name</th><th>baseUnit</th><th>pricePerBase</th><th>useConversions</th><th>active</th></tr></thead>'+
        '<tbody><tr><td></td><td></td><td>each</td><td></td><td>false</td><td>true</td></tr></tbody></table>'+
        '<script>window.onload=()=>window.print()<\\/script>'+
        '</body></html>'
      );
      w.document.close();
    });

    $("#csv-import").addEventListener("click", ()=>{
      if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
      $("#csv-file").click();
    });
    $("#csv-file").addEventListener("change", async (ev)=>{
      const file=ev.target.files[0]; if(!file) return;
      Papa.parse(file, {
        header:true, skipEmptyLines:true,
        complete: async (res)=>{
          const rows=res.data||[]; if(!rows.length) return alert("No rows found.");
          let upserts=0, skipped=0;
          try{
            for(const r of rows){
              const name=(r.name||"").trim();
              const idRaw=(r.id||"").trim();
              let baseUnit=(r.baseUnit||"").trim()||"each";
              const pricePerBase=parseFloat(r.pricePerBase);
              const useConversions=bool(r.useConversions,false);
              const active=bool(r.active,true);
              if(!name || !isFinite(pricePerBase)){ skipped++; continue; }
              if(!ALLOWED_UNITS.includes(baseUnit)){ skipped++; continue; }
              const id=(idRaw ? slug(idRaw) : slug(name)) || undefined;
              const payload={name,baseUnit,pricePerBase,useConversions,active};
              if(id){ await fs.collection("catalog").doc(id).set(payload,{merge:false}); } else { await fs.collection("catalog").add(payload); }
              upserts++;
            }
            alert(`Import complete.\nUpserted: ${upserts}\nSkipped: ${skipped}`);
          }catch(e){ console.error(e); alert("Import failed. See console for details."); }
          finally{ ev.target.value=""; }
        }
      });
    });
  </script>
</body>
</html>


