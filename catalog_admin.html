<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro-Bakery — Catalog Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b0e; --panel:#121218; --ink:#f6f6f6; --muted:#a6a6b0;
      --gold:#d4af37; --gold-2:#b99416; --red:#ef4444; --green:#22c55e; --line:#23232b; --card:#171720;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:1.7rem}
    h1 .brand{color:var(--gold)}
    .status{color:var(--muted);font-size:.92rem}
    .btn{cursor:pointer;border:1px solid var(--gold);background:transparent;color:var(--gold);transition:.2s;border-radius:12px;padding:10px 12px}
    .btn:hover{background:var(--gold);color:var(--bg)}
    .btn.primary{background:var(--gold);color:var(--bg);border:1px solid var(--gold)}
    .btn.danger{border-color:var(--red);color:var(--red)}
    .btn.danger:hover{background:var(--red);color:#fff}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 20px rgba(0,0,0,.25);padding:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--gold);font-weight:700}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:.8rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1><span class="brand">Pro-Bakery</span> — Catalog Admin</h1>
      <div>
        <a href="index.html" class="btn" style="margin-right:10px">Back to Tracker</a>
        <span id="fb-status" class="status">Firebase: <em>checking…</em></span>
        <button id="login-btn" class="btn primary" style="margin-left:10px">Login</button>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="search" placeholder="Search products..." style="flex:1">
        <button id="clear" class="btn">Clear</button>
        <button id="export" class="btn">Export CSV</button>
        <button id="blank-csv" class="btn">Download Blank CSV</button>
        <button id="blank-xlsx" class="btn">Download Blank Excel</button>
        <button id="print-blank" class="btn">Print Blank Template</button>
        <button id="import" class="btn">Import CSV</button>
        <input id="csv-file" type="file" accept=".csv" style="display:none">
      </div>

      <div style="margin-top:16px;">
        <h2 style="margin:0 0 8px;color:var(--gold);font-size:1.1rem">Catalog</h2>
        <table id="cat-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Base Unit</th>
              <th>Price/Base</th>
              <th>Conversions</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="cat-tbody">
            <tr><td colspan="6" class="muted">No products found.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    /* ----- admin allow-list ----- */
    const ADMIN_UIDS = new Set([
      "In9nS195FPamjwoTM8aHDjJRq8r2",
      "csKdZoNF3ufwPVNS1tUmeRFzCnF2"
    ]);
    const $ = (id)=>document.getElementById(id);

    /* ----- Firebase init ----- */
    const firebaseConfig = {
      apiKey: "AIzaSyAMnZy_gRIu43w6RyvcgRFHcV6xQjBAriM",
      authDomain: "food-tracker-fd312.firebaseapp.com",
      projectId: "food-tracker-fd312"
    };
    firebase.initializeApp(firebaseConfig);
    const fs   = firebase.firestore();
    const auth = firebase.auth();

    /* Connection indicator – Firestore ping */
    (async function ping(){
      try{ await fs.collection("__ping").doc("ok").get();
        $("fb-status").innerHTML='Firebase: <strong class="ok">connected</strong>';
      }catch{ $("fb-status").innerHTML='Firebase: <strong class="err">offline</strong>'; }
    })();

    function applyAuthUI(u){ $("login-btn").textContent = u ? "Logout" : "Login"; }
    auth.onAuthStateChanged(applyAuthUI);
    $("login-btn").onclick = async ()=>{
      if(auth.currentUser){ await auth.signOut(); return; }
      const email=prompt("Admin email:"); if(!email) return;
      const pw=prompt("Password:"); if(pw==null) return;
      try{ await auth.signInWithEmailAndPassword(email.trim(), pw); }
      catch (e) {
        console.error("Auth error:", e);
        alert(`Login failed: ${e.code || ''} ${e.message || ''}`);
      }


    /* Allowed units (used in templates & validation) */
    const ALLOWED_UNITS = ["each","piece","kg","g","lb","L","ml","fl oz"];

    /* Live subscribe and render */
    const CATALOG = new Map(); // id -> data
    fs.collection("catalog").onSnapshot(s=>{
      CATALOG.clear();
      s.forEach(d=> CATALOG.set(d.id, d.data()));
      render();
    });

    function render(){
      const q = $("search").value.trim().toLowerCase();
      const tbody = $("cat-tbody"); tbody.innerHTML = "";
      const rows = [];
      CATALOG.forEach((v,id)=> rows.push({id,...v}));
      rows.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      const filtered = rows.filter(r=> !q || (r.name||"").toLowerCase().includes(q));
      if(!filtered.length){
        const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="6" class="muted">No products found.</td>`; tbody.appendChild(tr); return;
      }
      filtered.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${p.name||""}</td>
          <td>${p.baseUnit||""}</td>
          <td>$${Number(p.pricePerBase||0).toFixed(2)}</td>
          <td>${p.useConversions?"Yes":"No"}</td>
          <td>${p.active?"Yes":"No"}</td>
          <td>
            <button class="btn" data-edit="${p.id}">Edit</button>
            <button class="btn danger" data-del="${p.id}" style="margin-left:6px;">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // wire actions
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
          if(!confirm("Delete this product?")) return;
          try{ await fs.collection("catalog").doc(btn.getAttribute("data-del")).delete(); }
          catch(e){ console.error(e); alert("Delete failed."); }
        };
      });
      tbody.querySelectorAll("[data-edit]").forEach(btn=>{
        const id=btn.getAttribute("data-edit");
        btn.onclick = async ()=>{
          if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
          const cur = CATALOG.get(id);
          const name = prompt("Name:", cur?.name ?? ""); if(name==null) return;
          const baseUnit = prompt(`Base unit (${ALLOWED_UNITS.join(", ")}):`, cur?.baseUnit ?? "each"); if(baseUnit==null) return;
          const price = prompt("Price per base unit:", String(cur?.pricePerBase ?? "")); if(price==null) return;
          const useConv = confirm("Enable related-unit conversions for this product?\nOK = Yes  |  Cancel = No");
          const active = confirm("Mark item ACTIVE?\nOK = Active  |  Cancel = Inactive");
          const payload = { name, baseUnit, pricePerBase: parseFloat(price)||0, useConversions: useConv, active };
          try{ await fs.collection("catalog").doc(id).set(payload, { merge:false }); }
          catch(e){ console.error(e); alert("Save failed."); }
        };
      });
    }
    $("search").oninput=render; $("clear").onclick=()=>{ $("search").value=""; render(); };

    /* Export CSV (full columns) */
    $("export").onclick = async ()=>{
      const rows=[["id","name","baseUnit","pricePerBase","useConversions","active"]];
      CATALOG.forEach((v,id)=> rows.push([id, v.name||"", v.baseUnit||"", v.pricePerBase||0, !!v.useConversions, !!v.active]));
      const csv = Papa.unparse(rows);
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="catalog_export.csv"; a.click(); URL.revokeObjectURL(url);
    };

    /* Download Blank CSV (minimal headers ONLY) */
    $("blank-csv").onclick = ()=>{
      const rows=[["name","baseUnit","pricePerBase"]]; // no id/useConversions/active
      const csv=Papa.unparse(rows);
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="catalog_blank.csv"; a.click(); URL.revokeObjectURL(url);
    };

    /* Download Blank Excel (XLSX) with dropdown for baseUnit */
    $("blank-xlsx").onclick = ()=>{
      const wb = XLSX.utils.book_new();
      // Main sheet with headers
      const ws = XLSX.utils.aoa_to_sheet([["name","baseUnit","pricePerBase"]]);
      // Hidden sheet listing allowed units
      const wsUnits = XLSX.utils.aoa_to_sheet(ALLOWED_UNITS.map(u=>[u]));
      XLSX.utils.book_append_sheet(wb, ws, "Template");
      XLSX.utils.book_append_sheet(wb, wsUnits, "_units");
      wsUnits["!hidden"] = 1;

      // Data validation: dropdown for baseUnit (column B) for rows 2..200
      const endRow = 200;
      const range = `B2:B${endRow}`;
      ws['!dataValidation'] = [{
        type: 'list',
        allowBlank: 1,
        sqref: range,
        formulas: ['=_units!$A$1:$A$' + ALLOWED_UNITS.length]
      }];

      XLSX.writeFile(wb, "catalog_blank.xlsx");
    };

    /* Print Blank Template (simple printable sheet with allowed units shown) */
    $("print-blank").onclick = ()=>{
      const w=window.open("", "_blank");
      w.document.write(`
        <html><head><title>Catalog Template</title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
          table{border-collapse:collapse;width:100%} th,td{border:1px solid #999;padding:6px}
          th{background:#eee}
        </style></head><body>
        <h2>Catalog Template</h2>
        <p>Fill rows and import as CSV. Required columns: <strong>name</strong>, <strong>baseUnit</strong>, <strong>pricePerBase</strong>.</p>
        <p>Allowed base units: ${ALLOWED_UNITS.join(", ")}.</p>
        <table>
          <thead><tr><th>name</th><th>baseUnit</th><th>pricePerBase</th></tr></thead>
          <tbody>
            ${Array.from({length:15}).map(()=>"<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>").join("")}
          </tbody>
        </table>
        <script>window.print();<\/script>
        </body></html>`);
      w.document.close();
    };

    /* Import CSV (overwrite by id if present, else slug(name)) */
    $("import").onclick = ()=> $("csv-file").click();
    $("csv-file").addEventListener("change", async ev=>{
      const file=ev.target.files[0]; if(!file) return;
      if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) { alert("Admin login required."); ev.target.value=""; return; }
      Papa.parse(file,{header:true,skipEmptyLines:true,complete: async (res)=>{
        const rows=res.data||[]; if(!rows.length) return alert("No rows found.");
        let upserts=0, skipped=0;
        for(const r of rows){
          try{
            const name=(r.name||"").trim();
            const baseUnit=(r.baseUnit||"each").trim();
            const pricePerBase=parseFloat(r.pricePerBase);
            const idRaw=(r.id||"").trim();        // optional, used only if provided
            if(!name || !ALLOWED_UNITS.includes(baseUnit) || !isFinite(pricePerBase)){ skipped++; continue; }
            const id = idRaw ? idRaw : name.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"");
            // Hidden fields default; can be edited later in UI
            const payload={ name, baseUnit, pricePerBase, useConversions:false, active:true };
            await fs.collection("catalog").doc(id).set(payload, { merge:false });
            upserts++;
          }catch(e){ console.error(e); skipped++; }
        }
        alert(`Import complete.\nUpserted: ${upserts}\nSkipped: ${skipped}`);
        ev.target.value="";
      }});
    });

    /* Notes:
       - "Conversions" column shows whether related units (L ↔ ml ↔ fl oz, kg ↔ g ↔ lb) are available on the tracker.
       - "Active" controls whether an item appears in the tracker’s product list.
       - "Actions" are the edit/delete controls.
       - Blank templates intentionally omit id/useConversions/active; export CSV includes them.
    */
  </script>
</body>
</html>


