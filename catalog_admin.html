<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro-Bakery — Catalog Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b0e; --panel:#121218; --ink:#f6f6f6; --muted:#a6a6b0;
      --gold:#d4af37; --gold-2:#b99416; --red:#ef4444; --green:#22c55e; --line:#23232b; --card:#171720;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:1.7rem}
    h1 .brand{color:var(--gold)}
    .status{color:var(--muted);font-size:.92rem}
    .ok{color:var(--green)}
    .err{color:#f87171}
    .btn{cursor:pointer;border:1px solid var(--gold);background:transparent;color:var(--gold);transition:.2s;border-radius:12px;padding:10px 12px}
    .btn:hover{background:var(--gold);color:var(--bg)}
    .btn.primary{background:var(--gold);color:var(--bg);border:1px solid var(--gold)}
    .btn.danger{border-color:var(--red);color:var(--red)}
    .btn.danger:hover{background:var(--red);color:#fff}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 20px rgba(0,0,0,.25);padding:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:var(--gold);font-weight:700}
    .muted{color:var(--muted)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1><span class="brand">Pro-Bakery</span> — Catalog Admin</h1>
      <div>
        <a href="index.html" class="btn" style="margin-right:10px">Back to Tracker</a>
        <span id="fb-status" class="status">Firebase: <em>checking…</em></span>
        <button id="login-btn" class="btn primary" style="margin-left:10px">Login</button>
      </div>
    </div>

    <!-- Add / Edit -->
    <div class="panel">
      <h2 style="margin:0 0 8px;color:var(--gold);font-size:1.1rem">Add / Edit Product</h2>
      <div class="grid-3">
        <label>Name
          <input id="name" placeholder="e.g., Chocolate Cake" autocomplete="off" />
        </label>
        <label>Base Unit
          <select id="baseUnit">
            <option value="each">each</option><option value="piece">piece</option>
            <option value="kg">kg</option><option value="g">g</option><option value="lb">lb</option>
            <option value="L">L</option><option value="ml">ml</option><option value="fl oz">fl oz</option>
          </select>
        </label>
        <label>Price per Base Unit
          <input id="price" type="number" step="0.01" min="0" placeholder="e.g., 25.00" />
        </label>
      </div>
      <div class="grid-3" style="margin-top:8px;">
        <label>Use Conversions?
          <select id="useconv"><option value="false">No</option><option value="true">Yes</option></select>
        </label>
        <label>Active?
          <select id="active"><option value="true">Active</option><option value="false">Inactive</option></select>
        </label>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button id="save" class="btn primary" type="button">Save / Update</button>
          <button id="clear" class="btn" type="button">Clear</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">You must be logged in with an admin account to add/update/delete items.</div>
    </div>

    <!-- List / CSV / XLSX -->
    <div class="panel" style="margin-top:14px;">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="search" placeholder="Search products..." style="flex:1" />
        <button id="clear-search" class="btn">Clear</button>
        <button id="export" class="btn">Export CSV</button>
        <button id="export-xlsx" class="btn">Export Excel (.xlsx with dropdowns)</button>
        <button id="blank-csv" class="btn">Download Blank CSV</button>
        <button id="download-xlsx" class="btn">Download Excel Template (.xlsx)</button>
        <button id="import" class="btn">Import CSV/XLSX</button>
        <input id="csv-file" type="file" accept=".csv,.xlsx" style="display:none" />
      </div>

      <div style="margin-top:16px;">
        <h2 style="margin:0 0 8px;color:var(--gold);font-size:1.1rem">Catalog</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Base Unit</th>
              <th>Price/Base</th>
              <th>Conversions</th>
              <th>Active</th>
              <th style="width:200px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">No products found.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Libs (primary) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /* ---------- Helpers & XLSX fallback ---------- */
    function $(id){ return document.getElementById(id); }

    // If the primary XLSX CDN fails to load, try a fallback; also provide a robust saver
    (function ensureXLSX(){
      function fallback(){
        var s=document.createElement('script');
        s.src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        document.head.appendChild(s);
      }
      setTimeout(()=>{ if(typeof XLSX==="undefined") fallback(); }, 800);
    })();

    function saveWorkbook(wb, filename){
      try{
        if (typeof XLSX !== "undefined" && XLSX.writeFile) {
          XLSX.writeFile(wb, filename);
          return;
        }
      }catch(e){}
      try{
        const data = XLSX.write(wb, { bookType:"xlsx", type:"array" });
        const blob = new Blob([data], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
        URL.revokeObjectURL(url);
      }catch(e){
        console.error("XLSX save failed:", e);
        alert("Could not generate the Excel file. Refresh and ensure the XLSX script isn’t blocked.");
      }
    }

    /* ---------- Firebase ---------- */
    const ADMIN_UIDS = new Set([
      "In9nS195FPamjwoTM8aHDjJRq8r2",
      "csKdZoNF3ufwPVNS1tUmeRFzCnF2"
    ]);

    const firebaseConfig = {
      apiKey: "AIzaSyBUl3_b1LPQ98uYnvkxJBAU-gE3Jj22X0I",
      authDomain: "pro-bakery-tracker.firebaseapp.com",
      databaseURL: "https://pro-bakery-tracker-default-rtdb.firebaseio.com",
      projectId: "pro-bakery-tracker",
      storageBucket: "pro-bakery-tracker.firebasestorage.app",
      messagingSenderId: "676035266941",
      appId: "1:676035266941:web:503224475b25d65e7b6414"
    };

    firebase.initializeApp(firebaseConfig);
    const fs   = firebase.firestore();
    const auth = firebase.auth();

    async function ping(){
      try{
        await fs.collection("catalog").limit(1).get();
        $("fb-status").innerHTML = 'Firebase: <strong class="ok">connected</strong>';
      }catch(e){
        if(e.code === "permission-denied"){
          $("fb-status").innerHTML = 'Firebase: <strong class="ok">connected</strong> <span class="status">(login required)</span>';
        }else{
          console.error("Firestore ping error", e);
          $("fb-status").innerHTML = 'Firebase: <strong class="err">offline</strong>';
        }
      }
    }
    ping();

    function applyAuthUI(u){
      $("login-btn").textContent = u ? "Logout" : "Login";
      renderWithRows(_lastGoodRows);
    }
    auth.onAuthStateChanged(applyAuthUI);

    $("login-btn").onclick = async ()=>{
      if (auth.currentUser){ await auth.signOut(); return; }
      const email = prompt("Admin email:"); if(!email) return;
      const pw    = prompt("Password:");   if(pw==null) return;
      try{ await auth.signInWithEmailAndPassword(email.trim(), pw); }
      catch(e){ console.error(e); alert("Login failed."); }
    };

    /* ---------- State ---------- */
    const ALLOWED_UNITS = ["each","piece","kg","g","lb","L","ml","fl oz"];
    const CATALOG = new Map();
    let editId = null;
    let _lastGoodRows = [];

    /* ---------- Live subscribe with fail-loud error handling ---------- */
    fs.collection("catalog").onSnapshot(
      (s)=>{
        const rows=[];
        s.forEach(d=> rows.push({id:d.id, ...d.data()}));
        _lastGoodRows = rows;
        renderWithRows(rows);
      },
      (err)=>{
        console.error("catalog onSnapshot error:", err);
        $("fb-status").innerHTML = 'Firebase: <strong class="err">read error</strong> ' +
          '<span class="status">'+ (err.code||err.message||"") +'</span>';
        // show last known good data if available
        renderWithRows(_lastGoodRows);
        if (err.code === "permission-denied") {
          alert("Login required to view catalog. Click Login (top-right).");
        }
      }
    );

    /* ---------- Render ---------- */
    function renderWithRows(rows){
      const q = $("search").value.trim().toLowerCase();
      const tbody = $("tbody"); tbody.innerHTML = "";
      const sorted = [...rows].sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      let filtered = sorted.filter(r=> !q || (r.name||"").toLowerCase().includes(q));

      // If the search is hiding everything, auto-clear once for convenience
      if (!filtered.length && q) {
        $("search").value = "";
        filtered = sorted;
      }

      if(!filtered.length){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td colspan="6" class="muted">No products found.</td>`;
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${p.name||""}</td>
          <td>${p.baseUnit||""}</td>
          <td>$${Number(p.pricePerBase||0).toFixed(2)}</td>
          <td>${p.useConversions?"Yes":"No"}</td>
          <td>${p.active?"Yes":"No"}</td>
          <td>
            <button class="btn" data-edit="${p.id}">Edit</button>
            <button class="btn danger" data-del="${p.id}" style="margin-left:6px;">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // wire actions
      tbody.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.onclick = ()=>{
          const id=btn.getAttribute("data-edit");
          const cur=rows.find(r=>r.id===id); if(!cur) return;
          editId = id;
          $("name").value = cur.name||"";
          $("baseUnit").value = cur.baseUnit||"each";
          $("price").value = cur.pricePerBase ?? "";
          $("useconv").value = String(!!cur.useConversions);
          $("active").value = String(!!cur.active);
          window.scrollTo({top:0,behavior:"smooth"});
        };
      });
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) return alert("Admin login required.");
          if(!confirm("Delete this product?")) return;
          try{ await fs.collection("catalog").doc(btn.getAttribute("data-del")).delete(); }
          catch(e){
            console.error(e);
            alert(e.code === "permission-denied" ? "Permission denied by Firestore rules." : "Delete failed.");
          }
        };
      });
    }

    // search & clear
    $("clear-search").onclick = ()=>{ $("search").value=""; renderWithRows(_lastGoodRows); };

    /* ---------- Form actions ---------- */
    $("clear").onclick = ()=>{
      editId = null;
      $("name").value=""; $("baseUnit").value="each"; $("price").value="";
      $("useconv").value="false"; $("active").value="true";
    };

    const slugify = (s)=> s.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"");
    const parseBool = (v)=>{ if(typeof v==="boolean") return v; const t=String(v??"").trim().toLowerCase(); return ["true","1","yes","y"].includes(t); };

    $("save").onclick = async ()=>{
      try { await auth.currentUser?.reload(); } catch(e) {}
      const u = auth.currentUser;
      if (!u || !ADMIN_UIDS.has(u.uid)) { alert("Admin login required."); return; }

      const name           = $("name").value.trim();
      const baseUnit       = $("baseUnit").value;
      const pricePerBase   = parseFloat($("price").value);
      const useConversions = $("useconv").value === "true";
      const active         = $("active").value === "true";

      if (!name || !ALLOWED_UNITS.includes(baseUnit) || Number.isNaN(pricePerBase) || pricePerBase < 0) {
        alert("Fill name, base unit, and a non-negative price.");
        return;
      }

      const payload = { name, baseUnit, pricePerBase, useConversions, active };

      try {
        if (editId) {
          await fs.collection("catalog").doc(editId).set(payload, { merge: false });
        } else {
          const id = slugify(name);
          await fs.collection("catalog").doc(id).set(payload, { merge: false });
        }
        $("clear").click();
      } catch (e) {
        console.error(e);
        alert(e.code === "permission-denied" ? "Permission denied by Firestore rules." : "Save failed.");
      }
    };

    /* ---------- CSV Export ---------- */
    $("export").onclick = ()=>{
      const rows=[["id","name","baseUnit","pricePerBase","useConversions","active"]];
      _lastGoodRows.forEach(r=> rows.push([r.id, r.name||"", r.baseUnit||"", Number(r.pricePerBase||0), !!r.useConversions, !!r.active]));
      const csv = Papa.unparse(rows);
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="catalog_export.csv"; a.click(); URL.revokeObjectURL(url);
    };

    /* ---------- Excel workbook builders ---------- */
    function buildCatalogWorkbook(includeData = true) {
      const wb = XLSX.utils.book_new();

      // Units sheet for baseUnit dropdown
      const wsUnits = XLSX.utils.aoa_to_sheet([["Units"], ...ALLOWED_UNITS.map(u=>[u])]);
      XLSX.utils.book_append_sheet(wb, wsUnits, "Units");

      // Booleans (true/false) sheet
      const wsBool = XLSX.utils.aoa_to_sheet([["Booleans"],["true"],["false"]]);
      XLSX.utils.book_append_sheet(wb, wsBool, "Booleans");

      // Catalog sheet
      const headers=["id (optional)","name","baseUnit","pricePerBase","useConversions","active"];
      const rows=[headers];
      if (includeData) {
        const dataRows = _lastGoodRows
          .map(r=> [r.id, r.name||"", r.baseUnit||"", Number(r.pricePerBase||0), !!r.useConversions, !!r.active])
          .sort((a,b)=> String(a[1]).localeCompare(String(b[1])));
        rows.push(...dataRows);
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);

      // validation over a generous range
      ws["!ref"] = "A1:F1001";
      ws["!dataValidation"] = [
        { sqref:"C2:C1001", type:"list", allowBlank:true, showErrorMessage:true, errorTitle:"Invalid Unit", error:"Choose a unit from the dropdown.", formula1:"=Units!$A$2:$A$"+(ALLOWED_UNITS.length+1) },
        { sqref:"E2:E1001", type:"list", allowBlank:true, formula1:"=Booleans!$A$2:$A$3" },
        { sqref:"F2:F1001", type:"list", allowBlank:true, formula1:"=Booleans!$A$2:$A$3" }
      ];

      XLSX.utils.book_append_sheet(wb, ws, "Catalog");
      return wb;
    }

    $("export-xlsx").onclick = ()=>{ const wb = buildCatalogWorkbook(true);  saveWorkbook(wb, "catalog_export.xlsx"); };
    $("download-xlsx").onclick = ()=>{ const wb = buildCatalogWorkbook(false); saveWorkbook(wb, "catalog_blank_template.xlsx"); };

    /* ---------- Blank CSV ---------- */
    $("blank-csv").onclick = ()=>{
      const rows=[["id (optional)","name","baseUnit","pricePerBase","useConversions","active"]];
      const csv=Papa.unparse(rows);
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="catalog_blank.csv"; a.click(); URL.revokeObjectURL(url);
    };

    /* ---------- Import CSV or XLSX ---------- */
    $("import").onclick = ()=> $("csv-file").click();

    $("csv-file").addEventListener("change", async ev=>{
      const file=ev.target.files[0]; if(!file) return;
      if(!auth.currentUser || !ADMIN_UIDS.has(auth.currentUser.uid)) { alert("Admin login required."); ev.target.value=""; return; }

      const name=file.name.toLowerCase();

      const upsertMany = async (records)=>{
        let created=0, overwritten=0, skipped=0;
        for(const r of records){
          try{
            const nm=(r.name||"").trim();
            const base=(r.baseUnit||"each").trim();
            const price=parseFloat(r.pricePerBase);
            const idRaw=(r.id||"").trim();
            const useC = (typeof r.useConversions==="undefined") ? false : r.useConversions;
            const act  = (typeof r.active==="undefined") ? true  : r.active;

            const useConversions = parseBool(useC);
            const active = parseBool(act);

            if(!nm || !ALLOWED_UNITS.includes(base) || !isFinite(price) || price<0){ skipped++; continue; }
            const id = idRaw ? slugify(idRaw) : slugify(nm);

            const ref=fs.collection("catalog").doc(id);
            const exists=(await ref.get()).exists;
            await ref.set({name:nm, baseUnit:base, pricePerBase:price, useConversions, active}, {merge:false});
            exists ? overwritten++ : created++;
          }catch(e){ console.error(e); skipped++; }
        }
        alert(`Import complete.\nCreated: ${created}\nOverwritten: ${overwritten}\nSkipped: ${skipped}`);
      };

      try{
        if(name.endsWith(".xlsx")){
          const data=await file.arrayBuffer();
          const wb=XLSX.read(data,{type:"array"});
          const sheetName = wb.Sheets["Catalog"] ? "Catalog" : wb.SheetNames[0];
          const sheet = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
          if(!rows.length) { alert("No rows found."); return; }
          await upsertMany(rows);
        }else{
          Papa.parse(file,{
            header:true,
            skipEmptyLines:true,
            complete: async (res)=>{
              const rows=res.data||[]; if(!rows.length){ alert("No rows found."); return; }
              await upsertMany(rows);
            }
          });
        }
      }finally{
        ev.target.value="";
      }
    });
  </script>
</body>
</html>






